<div class="container">
  
  <div class="article-block">
    
    <div class="row">
      <div class="title-block">
        
        <h1 class="article-title"><%= @article.title%></h1>
      
        <div class="article-btn-group " id="<%= @article.id %>">
          <% if current_user.collector?(@article) %>
            <button class="uncollect btn btn-default" id="<%= @collection.id%>">
              取消收藏
            </button>
          <% else%>
            <button class="collect btn btn-default" >
              收藏
            </button>
          <% end %>

          <button class="go-reply btn btn-default">新增回覆</button>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="article-content-block">
        <div class="avatar-block col-md-2" id="<% @article.user.id %>">
          <% if @article.user.avatar %>
            <%= filestack_image @article.user.avatar, transform: filestack_transform.resize(width:100, height:100), class:"img-responsive img-rounded "%>
          <% else %>
            <%= image_tag "league_card.png", class:"img-responsive img-rounded "%>
          <% end %>
          <p><%= link_to @article.user.name, articles_user_path(@article.user)%></p>
          <%= render :partial => "shared/add_friend_button", :locals => { :user => @article.user} %>   
        </div>
        <div class="text-content col-md-10">
          <%= image_tag @article.image, class:"img-responsive img-rounded " if @article.image && @article.image != "" %>
          <p><%= @article.content %></p>
        </div>
        <div class="btn-control-group text-right">
          <% if current_user == @article.user || current_user.admin? %>
            <%= link_to '<i class = "glyphicon glyphicon-remove text-danger" aria-hidden="true"></i>'.html_safe, article_path(@article), method: :delete, data:{confirm:"Are you sure>"}%>
          <% end %>
        </div>
      </div>
        
      
        
    </div>

  </div>
   
  <div class="reply-list">
    <% @article.replies.all.each do |reply| %>
      <div class="row">
        <div class="reply-content-block ">
          <div class="avatar-block col-md-2" id="<%= reply.id%>">
            <% if @article.user.avatar %>
              <%= filestack_image @article.user.avatar, transform: filestack_transform.resize(width:100, height:100), class:"img-responsive img-rounded "%>
            <% else %>
              <%= image_tag "league_card.png", class:"img-responsive img-rounded "%>
            <% end %>
            <p><%= link_to @article.user.name, articles_user_path(@article.user)%></p>
            <%= render :partial => "shared/add_friend_button", :locals => { :user => @article.user} %>  
          </div>

          <div class="text-content col-md-10">
            <p><%= reply.content %></p>
          </div>
          <div class="btn-control-group text-right">
            <% if current_user.admin? || current_user == @article.user || current_user == reply.user %>
            <%= link_to '<i class = "glyphicon glyphicon-remove text-danger" aria-hidden="true"></i>'.html_safe, reply_path(reply), method: :delete, data:{confirm:"Are you sure>"} %>
            <% end %>
          </div>
        </div>        
      </div>
    <% end %>  
  </div> 
  <div class="reply-form">
    <%= form_for @reply do |f|%>
      <%= f.text_area :content, class: "form-control" %>
      <br>
      <%= f.hidden_field :article_id, :value => @article.id %>
      <%= f.submit "回覆", class: "btn btn-default" %>
    <% end %>
  </div>
    
</div>

<script type="text/javascript">
  $(".btn-add-friend").on('click', function(event){
    var user_id = event.target.id;
    $.ajax({
      url: "/friendships",
      method: "POST",
      datatype: "json",
      data: {
        user_id: user_id
      },
      success: function(data){
        var btn = $(".btn-add-friend");
        if(data["status"] == 3){
          $(btn).html("好友");
          $(btn).prop('disabled', true);
        }
        else if(data["status"] == 2){
          $(btn).html("取消邀請");
          $(btn).removeClass("btn-add-friend");
          $(btn).addClass("btn-cancel-invite");
        }
        
      }
    });
  });

  $(".article-btn-group").on('click', '.collect', function(event){
    var article_id = event.target.parentNode.id;
    $.ajax({
      url: "/collections/",
      method: "POST",
      datatype: "json",
      data: {
        article_id: article_id
      },
      success: function(data){
        var btn = $('<button class="uncollect btn btn-default" >取消收藏</button>');
        $(".article-btn-group").find(".collect").remove();
        $(btn).attr('id', data["collection_id"]);
        $(".article-btn-group").prepend(btn);
      }
    });
  });

  $(".article-btn-group").on('click', '.uncollect', function(event){
    var collection_id = event.target.id;
    $.ajax({
      url: "/collections/" + collection_id,
      method: "DELETE",
      datatype: "json",
      success: function(data){
        var btn = $('<button class="collect btn btn-default" >收藏</button>');
        $(".article-btn-group").find(".uncollect").remove();   

        $(".article-btn-group").prepend(btn);
      }
    });
  });
</script>

