<div class="container">
  <table class="table">
    <tbody>
      <tr>
        <td id="<% @article.user.id %>">
          <%= filestack_image @article.user.avatar, transform: filestack_transform.resize(width:100, height:100), class:"img-responsive img-rounded " if @article.user.avatar%>
          <%= link_to @article.user.name, articles_user_path(@article.user)%>
          <%= render :partial => "shared/add_friend_button", :locals => { :user => @article.user} %>       
        </td>
        <td>
          <%= filestack_image @article.image, transform: filestack_transform.resize(width:100, height:100), class:"img-responsive img-rounded " if @article.image%>
          <%= truncate(simple_format(@article.content), length: 1200)%>
          <% if current_user == @article.user || current_user.admin? %>
            <%= link_to '<i class = "glyphicon glyphicon-remove text-danger" aria-hidden="true"></i>'.html_safe, article_path(@article), method: :delete, data:{confirm:"Are you sure>"} %>
          <% end %>
        </td>
      </tr>
      
      <% @article.replies.all.each do |reply| %>
        <tr>          
          <td>
            <%= filestack_image reply.user.avatar, transform: filestack_transform.resize(width:100, height:100), class:"img-responsive img-rounded " if reply.user.avatar%>
            <%= reply.user.name %>
            <%= render :partial => "shared/add_friend_button", :locals => { :user => @article.user} %> 
          </td>
          <td>
            <%= truncate(simple_format(reply.content), length: 1200)%>
            <% if current_user.admin? || current_user == @article.user || current_user == reply.user %>
            <%= link_to '<i class = "glyphicon glyphicon-remove text-danger" aria-hidden="true"></i>'.html_safe, reply_path(reply), method: :delete, data:{confirm:"Are you sure>"} %>
            <% end %>
          </td>
        </tr>
      <% end %>
      
    </tbody>
  </table>
  <%= form_for @reply do |f|%>
    <%= f.text_area :content, class: "form-control" %>
    <br>
    <%= f.hidden_field :article_id, :value => @article.id %>
    <%= f.submit "回覆", class: "btn btn-default" %>
  <% end %>
</div>

<script type="text/javascript">
  $(".btn-add-friend").on('click', function(event){
    var user_id = event.target.id;
    $.ajax({
      url: "/friendships",
      method: "POST",
      datatype: "json",
      data: {
        user_id: user_id
      },
      success: function(data){
        var btn = $(".btn-add-friend");
        if(data["status"] == 3){
          $(btn).html("好友");
          $(btn).prop('disabled', true);
        }
        else if(data["status"] == 2){
          $(btn).html("取消邀請");
          $(btn).removeClass("btn-add-friend");
          $(btn).addClass("btn-cancel-invite");
        }
        
      }
    });
  });
</script>